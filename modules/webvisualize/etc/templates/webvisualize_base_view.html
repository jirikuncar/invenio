{#
## This file is part of Invenio.
## Copyright (C) 2013 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}
{% extends "page.html" %}
{% set title = _("Visualize - view") %}

{% block header %}
  {{ super() }}
  {%- css 'css/slick.grid.css', '01-recline' -%}
  {%- css 'css/flot.css', '01-recline' -%}

  {% js "js/underscore.js", '01-recline' %}
  {% js "js/backbone.js", '01-recline' %}
  {% js "js/mustache.js", '01-recline' %}
  {% js "js/jquery.event.drag-2.0.min.js", '01-recline' %}
  {% js "js/jquery-ui-1.8.16.custom.min.js", '01-recline' %}
  {% js "js/slick.grid.min.js", '01-recline' %}
  {% js "js/jquery.flot.js", '01-recline' %}
  {% js "js/recline.js", '01-recline' %}
{% endblock header %}

{% block body %}
<h1>TEST - view</h1>
<h2>{{ visualize_config.title }}</h2>
<h2>{{ visualize_config.id_creator }}</h2>
<h2>{{ visualize_config.graph_type }}</h2>
<h2>{{ visualize_config.config  }}</h2>

<h2>{{ visualizer }}</h2>

<div id="data-graph"></div>

<button id="change-scale" class="btn btn-primary">Change scale</button>

  <div class="btn-group" data-toggle="buttons-radio">
    <button id="lines-button" type="button" class="btn btn-primary graph-button" data-graph="lines">Lines</button>
    <button id="points-button" type="button" class="btn btn-primary graph-button" data-graph="points">Points</button>
    <button id="lines-and-points-button" type="button" class="btn btn-primary graph-button" data-graph="lines-and-points">Lines and Points</button>
    <button id="bars-button" type="button" class="btn btn-primary graph-button" data-graph="bars">Bars</button>
    <button id="columns-button" type="button" class="btn btn-primary graph-button" data-graph="columns">Columns</button>
  </div>


<div class="accordion" id="accordion2">
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseGrid">
        Table
      </a>
    </div>
    <div id="collapseGrid" class="accordion-body collapse in">
      <div class="accordion-inner">
        <div id="data-grid"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
(function($) {
  var vconfig = {{ visualize_config.config|safe }};
  // create the dataset in the usual way but specifying file attribute
  var dataset = new recline.Model.Dataset(
    {{ visualize_config.config|safe }});

  // TABLE
  var $data_grid = $("#data-grid");

  dataset.fetch();

  var grid = new recline.View.SlickGrid({
    model: dataset,
    el: $data_grid,
    state: {
      fitColumns:true, // Columns are distributed equally
      gridOptions: {
        autoHeight: true
      }
    }
  });
  grid.visible = true;
  grid.render();
  // GRAPH
  var $data_graph = $("#data-graph");

  var graph = new recline.View.Graph({
    console.log(dataset);
    model: dataset,
    state: {
      group: 'Name',
      series: ["Diff. last month", "Total N. of doc."],
      graphType: 'columns',
      //graphOptions:{
      //   yaxis:{
      //     min: 1, 
      //     ticks:[ 1, 10, 100, 1000, 10000, 100000, 1000000, 10000000],
      //     transform: function(v) {
      //       return v === 0 ? Math.log(0.00001): Math.log(v);
      //     } /*move away from zero*/   
      //  },
      //}
    }
  });

  $data_graph.append(graph.el);
  graph.render();
  graph.redraw();

  $("#change-scale").click(function() {
    if(graph.state.attributes.hasOwnProperty('graphOptions')){
      delete graph.state.attributes.graphOptions;
    } 
    else {
      graph.state.attributes['graphOptions'] = { 
          yaxis:{
            min: 1, 
            ticks:[ 1, 10, 100, 1000, 10000, 100000, 1000000, 10000000],
            transform: function(v) {
              return v === 0 ? Math.log(0.00001): Math.log(v);
            } /*move away from zero*/   
          },
        } 
    }
    graph.redraw();
  });

  $(".graph-button").click(function() {
      graph.state.attributes.graphType = $(this).attr('data-graph');
      graph.redraw();
  });

})(jQuery);

</script>
{% endblock javascript %}